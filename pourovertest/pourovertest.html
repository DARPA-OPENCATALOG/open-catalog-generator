<!DOCTYPE html>
<html>
<head>
<script type='text/javascript' src='utils.js'></script>
<script type='text/javascript' src="/pourover/test/underscore-min.js"></script>
<script type='text/javascript' src="/pourover/pourover.js"></script>
<script type='text/javascript' src='jquery-latest.js'></script>
<script type='text/javascript' src='jquery-1.9.1.js'></script>
 <script type='text/javascript' src="jquery-ui.js"></script>
<script type="text/javascript" src="templates.js"></script>
<script type="text/javascript" src="mustache.js"></script>
<script type="text/javascript" src='d3.min.js'></script>
<link rel="stylesheet" type="text/css" href="css/query_center.css"/>
<link rel='stylesheet' href='css/flick/jquery-ui-1.10.4.custom.css' type='text/css'/>

<script>
var view = [],
	menu_array = {"names":[], "teams":[], "categories":[]};
	
var alphaCharRange = {
		start: 65, end: 90
	}

$(document).ready(function() {
	var programs = getPrograms();


	programs.sort(sortByProperty('Program Name'));

	var software_docs = [],
	publications_docs = [];
	
	for (program in programs){
		var program_nm = programs[program]["Program Name"];
		
		if(programs[program]["Software File"] != ""){
			program_sw_file = getProgramDetails(programs[program]["Software File"]);
			for (sw_item in program_sw_file){
				var sw_object = program_sw_file[sw_item];
				software_docs.push(sw_object);
				createMenuArrays(sw_object["Categories"], "categories");
				createMenuArrays(sw_object["DARPA Program"], "names");
				createMenuArrays(sw_object["Program Teams"], "teams");
			}
		}
		else if(programs[program]["Pubs File"] != ""){
			program_pub_file = getProgramDetails(programs[program]["Pubs File"])
			for (pub_item in program_pub_file)
				var pub_object = program_pub_file[pub_item];
				publications_docs.push(pub_object);
				createMenuArrays(pub_object["Categories"], "categories");
				createMenuArrays(pub_object["DARPA Program"], "names");
				createMenuArrays(pub_object["Program Teams"], "teams");
		}
	}
	
	menu_array["categories"].sort(insensitive());
	var cat_menu = getQueryMenu(menu_array["categories"], "categories");
	$("#category_menu").html(cat_menu);
	
	//console.log(menu_array["categories"]);
	menu_array["names"].sort();
	//console.log(menu_array["names"]);
	menu_array["teams"].sort();
	//console.log(menu_array["teams"]);


	var sw_collection = new PourOver.Collection(software_docs);
	//var pub_collection = new PourOver.Collection(publications_docs);

	var category_filter = PourOver.makeInclusionFilter("Categories", menu_array["categories"]);
	var name_filter = PourOver.makeExactFilter("DARPA Program", menu_array["name"]);
	var team_filter = PourOver.makeInclusionFilter("Program Teams", menu_array["teams"]);

	sw_collection.addFilters([category_filter, name_filter, team_filter]);
	
	MyView = PourOver.View.extend({
		selectionFn: function(){
			var collection = this.collection,
				cat_col = collection.getCurrentFilteredItems("Categories");
				team_col = collection.getCurrentFilteredItems("Program Teams");
				name_col = collection.getCurrentFilteredItems("DARPA Program");
			return cat_col.and(team_col).and(name_col);		
		},
		render: function(){
			var items = this.getCurrentItems();
			showResults(items, templates.SoftwareCenter, "Software");
		}
	});
	
	view = new MyView("custom_view",sw_collection);
	view.render();
});

//gathers all values and puts them in the appropriate place in the menu_array
function createMenuArrays(argument, type){
	var entry_array = getStringArray(argument);
	for(entry in entry_array){
		if(!isInArray(entry_array[entry], menu_array[type])){
			menu_array[type].push(entry_array[entry]);
		}
	}
}

function createHeaderArray(query_array){
	var curr_header = '';
	var header_array = [];
	
	for(query in query_array){
		for (var i = alphaCharRange.start; i <= alphaCharRange.end; i++) {
			if (curr_header == '' && query_array[query].charAt(0) == curr_header){
				if(!isInArray(curr_header, header_array))
					header_array.push("");
			}
			curr_header = String.fromCharCode(i);
			if (query_array[query].charAt(0) == curr_header){
				if(!isInArray(curr_header, header_array)){
					header_array.push(curr_header);
				}
				break;
			}
		}
	}
	
	return header_array;
}

//creates the html for the Query Menu displayed in the UI
function getQueryMenu(query_arr, arr_type){
	var curr_header = '';
	var menu_html = '<div data-filter-name="' + arr_type + '" data-pourover-filter="makeExactFilter" id="pourover_' + arr_type + '" style="display:none">';
	var value_cnt = query_arr.length;
	var header_cnt = createHeaderArray(query_arr).length;
	var total_lines = curr_line_cnt = lines_per_column = 0;
	
	total_lines = header_cnt + value_cnt;
	lines_per_column = Math.ceil(total_lines / 6);
	
	for(query in query_arr){
		if (curr_line_cnt == 0){
			menu_html += '<div class="column">';
		}
		
		var term = query_arr[query];
		var first_letter = term.charAt(0).toUpperCase(); 
		if (curr_header == '' && first_letter == curr_header){
			menu_html += '<h3>&nbsp;</h3><ul>';
			curr_line_cnt ++;
		}
		
		if (first_letter == curr_header){
			if(curr_line_cnt == 0)
				menu_html += '<ul>';
			menu_html += '<li data-filter-item-name="'+ term + '" onclick="performQuery(this);" onmouseover="overBackgroundColor(this);" onmouseout="outBackgroundColor(this);">' + toCamelCase(term) + '</li>';
			curr_line_cnt ++;
		}
		else{
			for (var i = alphaCharRange.start; i <= alphaCharRange.end; i++) {
				curr_header = String.fromCharCode(i);
				if (first_letter == curr_header){
					menu_html += '</ul><h3>' + first_letter + '</h3><ul>';
					menu_html += '<li data-filter-item-name="'+ term + '" onclick="performQuery(this);" onmouseover="overBackgroundColor(this);" onmouseout="outBackgroundColor(this);">' + toCamelCase(term) + '</li>';
					curr_line_cnt = curr_line_cnt + 2;
					break;
				}
			}
		}
		
		if (curr_line_cnt >= lines_per_column){
			menu_html += '</ul></div>';
			curr_line_cnt = 0;
		}
	}	
	
	menu_html += '</ul></div></div></div><div style="clear: both;"></div>';	
	return menu_html;
}


function performQuery(chosen_item){
	var all_selected_items = result_set = [];
	
	if (chosen_item.selected == true)
		chosen_item.selected = false;
	else
		chosen_item.selected = true;
 
	if(chosen_item.style.backgroundColor != 'yellow')
		chosen_item.style.backgroundColor ='yellow';
	else
		chosen_item.style.backgroundColor ='transparent';
		
	var category_menu_list = $("#category_menu").find('li');
	var view_cat_filter = new PourOver.UI.SimpleSelectElement({filter: view.collection.filters.Categories});
	
	category_menu_list.each(function(li) {
		if (category_menu_list[li].selected == true){
			all_selected_items.push(category_menu_list[li]);
		}
	});	


	if(all_selected_items.length > 0){
		for (item in all_selected_items){
			if (item == 0)
				view_cat_filter.filter.query(all_selected_items[item].dataset.filterItemName);
			else
				view_cat_filter.filter.intersectQuery(all_selected_items[item].dataset.filterItemName);
		}

		var cat_cids = view_cat_filter.filter.current_query.cids,
		result_set = view_cat_filter.filter.collection.get(cat_cids);
		
			showResults(result_set, templates.SoftwareCenter, "Software");
		if(result_set.length == 0)
			alert("No Results Found");
	}
	else{
		showResults(view_cat_filter.filter.collection.items, templates.SoftwareCenter, "Software");
	}
	
	
	/*
		update filter
		NEED ACCORDIAN NOT TABS
		AND FILTER BAR
	
	*/
	
}

function showResults(items, template, property){
	var html = "<table id='collection_table'><tbody><tr>";
	items.sort(sortByProperty(property));
	for(item in items){
		if (items[item][property] == "")
				items[item][property] = "--";
		html += Mustache.to_html(template, items[item]);
		if (item%4 == 3)
			html += "</tr><tr>";
	}
	html += "</tr></tbody></table>";
	$("#collection_view").html(html);
}


function overBackgroundColor(item){
	if (item.style.backgroundColor == 'transparent' ||  item.style.backgroundColor == '')
		item.style.backgroundColor = '#B7CEEC';
}

function outBackgroundColor(item){
	if(item.style.backgroundColor != 'yellow') 
		item.style.backgroundColor = 'transparent';
	 
}

function insensitive(){
	return function(s1, s2) {
	  var s1lower = s1.toLowerCase();
	  var s2lower = s2.toLowerCase();
	  return s1lower > s2lower? 1 : (s1lower < s2lower? -1 : 0);
	};
}

function toCamelCase(str) {
	return str.replace(/(?:^|\s)\w/g, function(match) {
		return match.toUpperCase();
	});
}

function toggleMenu(arrow_id, arrow_alt){
	//$('someSelector').is('hidden')
	if($("#" + arrow_alt).css("display") == "none"){
		$("#" + arrow_id).attr("src", "arrow-down.gif");
		$("#" + arrow_alt).attr("style", "display:visible");
	}
	else{
		$("#" + arrow_id).attr("src", "arrow-up.gif");
		$("#" + arrow_alt).attr("style", "display:none");
	}
		
}

</script>
</head>
<body>
<!--Mega Drop Down Menu HTML. Retain given CSS classes-->
<div id="tabs" class="table-tabs ui-tabs ui-widget ui-widget-content ui-corner-all">
	<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all" role="tablist">
		<li class="ui-state-default ui-corner-top ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="tabs0" aria-labelledby="ui-id-1" aria-selected="true">
			<a id="ui-id-1" class="ui-tabs-anchor" href="#tabs0" role="presentation" tabindex="-1">Query By</a>
		</li>
	</ul>
	<div id="program">
		<div id="tabs0" class="ui-tabs-panel ui-widget-content ui-corner-bottom" aria-labelledby="ui-id-1" role="tabpanel" aria-expanded="true" aria-hidden="false">
			<p>Category<img src="arrow-up.gif" id="category_title" alt="pourover_categories" onclick="toggleMenu(this.id, this.alt);"/></p>
			<div id="category_menu" class="megamenu">
			</div>
		</div>	
	</div>	
</div>
<br>	
<div id='collection_view' class='collectionview'></div>
</body>