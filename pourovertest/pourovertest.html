<!DOCTYPE html>
<html>
<head>
<script type='text/javascript' src='utils.js'></script>
<script type='text/javascript' src="/pourover/test/underscore-min.js"></script>
<script type='text/javascript' src="/pourover/pourover.js"></script>
<script type='text/javascript' src='jquery-latest.js'></script>
<script type='text/javascript' src='jquery-1.9.1.js'></script>
 <script type='text/javascript' src="jquery-ui.js"></script>
<script type="text/javascript" src="templates.js"></script>
<script type="text/javascript" src="mustache.js"></script>
<script type="text/javascript" src='d3.min.js'></script>
<link rel="stylesheet" type="text/css" href="css/query_center.css"/>
<link rel='stylesheet' href='css/flick/jquery-ui-1.10.4.custom.css' type='text/css'/>

<script>
var view = [],
	menu_array = {"names":[], "categories":[], "teams":[]};
	
var alphaCharRange = {
		start: 31, end: 90
	}

$(document).ready(function() {
	var programs = getPrograms();


	programs.sort(sortByProperty('Program Name'));

	var artifacts = [];
	
	for (program in programs){
		var program_nm = programs[program]["Program Name"];
		
		if(programs[program]["Software File"] != ""){
			program_sw_file = getProgramDetails(programs[program]["Software File"]);
			for (sw_item in program_sw_file){
				var sw_object = program_sw_file[sw_item];
				artifacts.push(sw_object);
				createMenuArrays(sw_object["DARPA Program"], "names");
				createMenuArrays(sw_object["Categories"], "categories");
				createMenuArrays(sw_object["Program Teams"], "teams");
			}
		}
		
		if(programs[program]["Pubs File"] != ""){
			program_pub_file = getProgramDetails(programs[program]["Pubs File"])
			for (pub_item in program_pub_file){
				var pub_object = program_pub_file[pub_item];
				artifacts.push(pub_object);
				createMenuArrays(pub_object["DARPA Program"], "names");
				createMenuArrays(pub_object["Categories"], "categories");
				createMenuArrays(pub_object["Program Teams"], "teams");
			}
		}
	}
	
	menu_array["names"].sort();
	var name_menu = getQueryMenu(menu_array["names"], "names");
	$("#names_menu").html(name_menu);
	
	menu_array["categories"].sort(insensitive());
	var cat_menu = getQueryMenu(menu_array["categories"], "categories");
	$("#categories_menu").html(cat_menu);
	
	menu_array["teams"].sort();
	var team_menu = getQueryMenu(menu_array["teams"], "teams");
	$("#teams_menu").html(team_menu);
	
	var artifacts_collection = new PourOver.Collection(artifacts);

	var name_filter = PourOver.makeExactFilter("DARPA Program", menu_array["names"]);
	var category_filter = PourOver.makeInclusionFilter("Categories", menu_array["categories"]);
	var team_filter = PourOver.makeInclusionFilter("Program Teams", menu_array["teams"]);
	
	artifacts_collection.addFilters([name_filter, category_filter, team_filter]);
	
	MyView = PourOver.View.extend({
		selectionFn: function(){
			var collection = this.collection,
				name_col = collection.getCurrentFilteredItems("DARPA Program");
				cat_col = collection.getCurrentFilteredItems("Categories");
				team_col = collection.getCurrentFilteredItems("Program Teams");

			return cat_col.and(team_col).and(name_col);		
		},
		render: function(){
			var items = this.getCurrentItems();
			showResults(items);
		}
	});
	
	view = new MyView("custom_view",artifacts_collection);
	view.render();

});

//gathers all values and puts them in the appropriate place in the menu_array
function createMenuArrays(argument, type){
	var entry_array = getStringArray(argument);
	for(entry in entry_array){
		if(!isInArray(entry_array[entry], menu_array[type])){
			menu_array[type].push(entry_array[entry]);
		}
	}
}


function createHeaderArray(query_array){
	var curr_header = '';
	var header_array = [];
	
	for(query in query_array){
		for (var i = alphaCharRange.start; i <= alphaCharRange.end; i++) {
			if (curr_header == '' && query_array[query].charAt(0) == curr_header){
				if(!isInArray(curr_header, header_array))
					header_array.push("");
			}
			curr_header = String.fromCharCode(i);
			if (query_array[query].charAt(0) == curr_header){
				if(!isInArray(curr_header, header_array)){
					header_array.push(curr_header);
				}
				break;
			}
		}
	}
	
	return header_array;
}

//creates the html for the Query Menu displayed in the UI
function getQueryMenu(query_arr, arr_type){

	var curr_header = '';
	var menu_html = '<div data-filter-name="' + arr_type + '" data-pourover-filter="makeExactFilter" id="pourover_' + arr_type + '" style="display:none">';
	var value_cnt = query_arr.length;
	var header_cnt = createHeaderArray(query_arr).length;
	var total_lines = curr_line_cnt = lines_per_column = 0;
	
	total_lines = header_cnt + value_cnt;
	lines_per_column = Math.ceil(total_lines / 6);
	
	for(query in query_arr){
		if (curr_line_cnt == 0){
			menu_html += '<div class="column">';
		}
		
		var term = query_arr[query];
		var first_letter = term.charAt(0).toUpperCase(); 
		
		if (curr_header == '' && first_letter == curr_header){
			menu_html += '<h3>&nbsp;</h3><ul>';
			curr_line_cnt ++;
		}
		
		if (first_letter == curr_header){
			if(curr_line_cnt == 0)
				menu_html += '<ul>';
			menu_html += '<li data-filter-name="' + arr_type + '" data-filter-item-name="'+ term + '" onclick="performQuery(this);" onmouseover="overBackgroundColor(this);" onmouseout="outBackgroundColor(this);">' + toCamelCase(term) + '</li>';
			curr_line_cnt ++;
		}
		else{
			for (var i = alphaCharRange.start; i <= alphaCharRange.end; i++) {
				curr_header = String.fromCharCode(i);
				if (first_letter == curr_header){
					menu_html += '</ul><h3>' + first_letter + '</h3><ul>';
					menu_html += '<li data-filter-name="' + arr_type + '" data-filter-item-name="'+ term + '" onclick="performQuery(this);" onmouseover="overBackgroundColor(this);" onmouseout="outBackgroundColor(this);">' + toCamelCase(term) + '</li>';
					curr_line_cnt = curr_line_cnt + 2;
					break;
				}
			}
		}
		
		if (curr_line_cnt >= lines_per_column){
			menu_html += '</ul></div>';
			curr_line_cnt = 0;
		}
	}	
	
	menu_html += '</ul></div></div></div><div style="clear: both;"></div>';	
	return menu_html;
}


function performQuery(chosen_item){
	console.log("the chosen one");
	console.log(chosen_item);
	var all_selected_items = result_set = [];

	toggleItem(chosen_item);

	var menu_list = $("#query_tab").find('li');
	menu_list.each(function(li) {
		if (menu_list[li].selected == true){
			all_selected_items.push(menu_list[li]);
		}
	});
	
	var view_names_filter = new PourOver.UI.SimpleSelectElement({filter: view.collection.filters["DARPA Program"]});
	var view_cat_filter = new PourOver.UI.SimpleSelectElement({filter: view.collection.filters.Categories});
	var view_teams_filter = new PourOver.UI.SimpleSelectElement({filter: view.collection.filters["Program Teams"]});
	
	view_names_filter.filter.clearQuery();
	view_cat_filter.filter.clearQuery();
	view_teams_filter.filter.clearQuery();
	
	var n_num = 0, c_num = 0, t_num = 0;
	var n_html = '', c_html = '', t_html = '';
	var open_html = '<ul class="filter-container" style="display: block;">';
	var close_html = '<li class="filter filter-clear point-cursor" onclick="removeFilterValue(this);" data-filter-item-name="" data-filter-name=""><span class="filter-item-title">Clear Filters</span><div class="filter-close-container"><div class="filter-close">&times;</div></div></li></ul>';
	
	if(all_selected_items.length > 0){
	
		var selected_filter = '', selected_value = '';
		for (item in all_selected_items){

			//console.log(all_selected_items[item].attributes['data-filter-name'].value, t_num);
			selected_filter = all_selected_items[item].attributes['data-filter-name'].value;
			selected_value = all_selected_items[item].attributes['data-filter-item-name'].value;
			
			if(selected_filter == 'names' && n_num == 0){
				view_names_filter.filter.query(all_selected_items[item].dataset.filterItemName);
				n_html += open_html;
				n_html += addFilterValue(selected_filter, selected_value);
				n_num ++;
			}
			else if (selected_filter == 'names' && n_num > 0){
				view_names_filter.filter.intersectQuery(all_selected_items[item].dataset.filterItemName);
				n_html += addFilterValue(selected_filter, selected_value);
			}
			else if (selected_filter == 'categories' && c_num == 0){
				view_cat_filter.filter.query(all_selected_items[item].dataset.filterItemName);
				c_html += open_html;
				c_html += addFilterValue(selected_filter, selected_value);
				c_num ++;
			}
			else if (selected_filter == 'categories' && c_num > 0){
				view_cat_filter.filter.intersectQuery(all_selected_items[item].dataset.filterItemName);
				c_html += addFilterValue(selected_filter, selected_value);
			}
			else if (selected_filter == 'teams' && t_num == 0){
				view_teams_filter.filter.query(all_selected_items[item].dataset.filterItemName);
				t_html += open_html;
				t_html += addFilterValue(selected_filter, selected_value);
				t_num ++;
			}
			else if (selected_filter == 'teams' && t_num > 0){
				view_teams_filter.filter.intersectQuery(all_selected_items[item].dataset.filterItemName);
				t_html += addFilterValue(selected_filter, selected_value);
			}

		}

		if (n_html != ''){ n_html += close_html; $('#names_filter_div').html(n_html);}	
		if (c_html != ''){c_html += close_html; $('#categories_filter_div').html(c_html);}
		if (t_html != ''){ t_html += close_html; $('#teams_filter_div').html(t_html);}			
		
		//console.log(view_names_filter.filter);
		//console.log(view_cat_filter.filter);
		//console.log(view_teams_filter.filter);
		
		var current_cids = view_names_filter.filter.current_query.and(view_cat_filter.filter.current_query);
		current_cids = current_cids.and(view_teams_filter.filter.current_query).cids;
		
		//console.log(current_cids);
		
		var result_set = view.collection.get(current_cids);

		if(result_set.length == 0)
			alert("No Results Found");
		else
			showResults(result_set);
	}
	else{
		showResults(view.collection.items);
		$("#names_filter_div").html('');
		$("#categories_filter_div").html('');
		$("#teams_filter_div").html('');
	}
	
	
	/*
		update filter
	*/
	
}


function showResults(items){

	var html = "<table id='collection_table'><tbody><tr>";
	//console.log(property);
	//items.sort(sortByProperty(property));
	items.sort();

	for (var i = 0; i <= items.length; i++) {	
		if (i < items.length){
			
			if(typeof(items[i].Software) == "undefined")
				html += Mustache.to_html(templates.PublicationsCenter, items[i]);
			else
				html += Mustache.to_html(templates.SoftwareCenter, items[i]);
			
		}
		if (i%4 == 3)
			html += "</tr><tr>";
	}
	
	html += "</tr></tbody></table>";
	$("#collection_view").html(html);
}

function overBackgroundColor(item){
	if (item.style.backgroundColor == 'transparent' ||  item.style.backgroundColor == '')
		item.style.backgroundColor = '#B7CEEC';
}

function outBackgroundColor(item){
	if(item.style.backgroundColor != 'yellow') 
		item.style.backgroundColor = 'transparent';
	 
}

function insensitive(){
	return function(s1, s2) {
	  var s1lower = s1.toLowerCase();
	  var s2lower = s2.toLowerCase();
	  return s1lower > s2lower? 1 : (s1lower < s2lower? -1 : 0);
	};
}

function toCamelCase(str) {
	return str.replace(/(?:^|\s)\w/g, function(match) {
		return match.toUpperCase();
	});
}

function toggleMenu(arrow_id, arrow_alt){
	if($("#" + arrow_alt).css("display") == "none"){
		$("#" + arrow_id).attr("src", "arrow-down.gif");
		$("#" + arrow_alt).attr("style", "display:visible");
	}
	else{
		$("#" + arrow_id).attr("src", "arrow-up.gif");
		$("#" + arrow_alt).attr("style", "display:none");
	}
		
}

function toggleItem(item){
	if (item.selected == true)
		item.selected = false;
	else
		item.selected = true;
 
	if(item.style.backgroundColor != 'yellow')
		item.style.backgroundColor ='yellow';
	else
		item.style.backgroundColor ='transparent';
}

function addFilterValue(filter, value){
	html = '<li class="filter filter-value point-cursor" onclick="removeFilterValue(this);" data-filter-item-name="' + value + '" data-filter-name="' + filter + '"><span class="filter-item-title">' + value + '</span><div class="filter-close-container"><div class="filter-close">&times;</div></div></li>';
	return html;
}

function removeFilterValue(filter){
	var selected_filter = filter.attributes['data-filter-name'].value;
	var selected_value = filter.attributes['data-filter-item-name'].value;
	
	if(selected_filter != ''){
		var filter_list = $("#" + selected_filter + "_filter_div").find('li');

		filter_list.each(function(li) {
			if (filter_list[li].attributes['data-filter-item-name'].value == selected_value){
				$("#" + selected_filter + "_filter_div li").eq(li).remove();
				if(filter_list.length == 2){
					$("#" + selected_filter + "_filter_div li").remove();
				}
				performQuery($("#pourover_" + selected_filter).find('[data-filter-item-name="' + selected_value + '"]')[li]);
			}
		});		

	}
	else
	{
		performQuery('');
	}

	
}

</script>
</head>
<body>
<!--Mega Drop Down Menu HTML. Retain given CSS classes-->
<div id="tabs" class="table-tabs ui-tabs ui-widget ui-widget-content ui-corner-all">
	<ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all" role="tablist">
		<li class="ui-state-default ui-corner-top ui-tabs-active ui-state-active" role="tab" tabindex="0" aria-controls="tabs0" aria-labelledby="ui-id-1" aria-selected="true">
			<a id="ui-id-1" class="ui-tabs-anchor" href="#tabs0" role="presentation" tabindex="-1">Query All Artifacts</a>
		</li>
	</ul>
	<div id="program">
		<div id="query_tab" class="ui-tabs-panel ui-widget-content ui-corner-bottom" aria-labelledby="ui-id-1" role="tabpanel" aria-expanded="true" aria-hidden="false">
			<div id='names_tite_div' style='float:left; width:10%;'><p>By Program<img class="point-cursor" src="arrow-up.gif" id="name_title" alt="pourover_names" onclick="toggleMenu(this.id, this.alt);"/></p></div>
			<div id='names_filter_div' style='float:left; width:90%;'></div>
			<div id="names_menu" style='clear: both;' class="megamenu"></div>
			
			<div id='categories_tite_div' style='float:left; width:10%;'><p>By Category<img class="point-cursor" src="arrow-up.gif" id="category_title" alt="pourover_categories" onclick="toggleMenu(this.id, this.alt);"/></p></div>
			<div id='categories_filter_div' style='float:left; width:90%;'></div>
			<div id="categories_menu" style='clear: both;' class="megamenu"></div>
			
			<div id='teams_tite_div' style='float:left; width:10%;'><p>By Team<img class="point-cursor" src="arrow-up.gif" id="team_title" alt="pourover_teams" onclick="toggleMenu(this.id, this.alt);"/></p></div>
			<div id='teams_filter_div' style='float:left; width:90%;'></div>
			<div id="teams_menu" style='clear: both;' class="megamenu"></div>
		</div>	
	</div>	
</div>

<p><span id='results_title'>&nbsp;View Artifacts</span><img class="point-cursor" src="arrow-up.gif" id="collection_title" alt="collection_view" onclick="toggleMenu(this.id, this.alt);"/></p>	
<div id='collection_view' class='collectionview' style="display:none"></div>
</body>